# Atlas Cortex — Data Model

## Database Location

The Cortex database lives as a separate SQLite file mounted into the Open WebUI container. This keeps it independent from Open WebUI's own `webui.db` and survives container upgrades.

**Path:** `/data/cortex.db` (mounted from host volume)

## Schema

### ha_devices

Device registry synced from Home Assistant nightly.

```sql
CREATE TABLE ha_devices (
    entity_id TEXT PRIMARY KEY,         -- "light.living_room"
    friendly_name TEXT NOT NULL,        -- "Living Room Lights"
    domain TEXT NOT NULL,               -- light, switch, sensor, climate, lock, cover, fan, media_player
    aliases TEXT DEFAULT '[]',          -- JSON: ["living room", "main lights", "front room lights"]
    capabilities TEXT DEFAULT '[]',     -- JSON: ["turn_on", "turn_off", "set_brightness", "set_color"]
    state TEXT,                         -- last known state: "on", "off", "72.5", "locked"
    discovered_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_seen TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Notes:**
- `aliases` are generated by the LLM during nightly discovery — common ways a user might refer to the device
- `capabilities` are derived from the HA domain and device class
- `state` is refreshed on each nightly run and on-demand when Layer 2 handles a command

### command_patterns

Regex patterns for matching natural language to HA actions. Grows automatically over time.

```sql
CREATE TABLE command_patterns (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    pattern TEXT NOT NULL,              -- regex: "turn (on|off) (?:the )?(.+)"
    intent TEXT NOT NULL,               -- toggle, get_state, set_brightness, set_temp, lock, unlock, etc.
    entity_domain TEXT,                 -- which HA domain this targets (light, switch, etc.)
    entity_match_group INTEGER,         -- which regex capture group contains the entity name
    value_match_group INTEGER,          -- which capture group contains the value (nullable)
    response_template TEXT,             -- "Done — {entity} is now {state}"
    source TEXT NOT NULL DEFAULT 'seed', -- 'seed' | 'nightly' | 'learned'
    confidence REAL DEFAULT 1.0,        -- higher = preferred when multiple patterns match
    hit_count INTEGER DEFAULT 0,
    last_hit TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_patterns_domain ON command_patterns(entity_domain);
CREATE INDEX idx_patterns_source ON command_patterns(source);
```

**Notes:**
- `source = 'seed'` — hardcoded initial patterns (turn on/off, get state, set brightness, etc.)
- `source = 'nightly'` — generated by the evolution job for newly discovered devices
- `source = 'learned'` — extracted from LLM fallthrough analysis
- `confidence` determines priority when multiple patterns match the same input
- `response_template` uses Python format strings with variables from the regex match

### interactions

Every single interaction is logged for learning and evolution.

```sql
CREATE TABLE interactions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id TEXT,                       -- Open WebUI user ID
    speaker_id TEXT,                    -- voice embedding match ID (null for typed)
    message TEXT NOT NULL,              -- user's input
    matched_layer TEXT NOT NULL,        -- 'instant' | 'tool' | 'llm'
    intent TEXT,                        -- classified intent (nullable for LLM layer)
    entities_used TEXT DEFAULT '[]',    -- JSON: ["light.bedroom", "sensor.temp_living"]
    sentiment TEXT,                     -- 'positive' | 'negative' | 'neutral' | 'question' | 'command'
    sentiment_score REAL,              -- VADER compound score (-1.0 to 1.0)
    response TEXT,                      -- what Atlas actually said
    response_time_ms INTEGER,           -- end-to-end response time
    llm_model TEXT,                     -- which model was used (null for Layer 1/2)
    llm_tool_calls TEXT DEFAULT '[]',   -- JSON: [{"tool": "...", "args": {...}, "result": "..."}]
    filler_used TEXT,                   -- what filler phrase was streamed (null if none)
    pattern_id INTEGER,                 -- which command_pattern matched (null if none)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (pattern_id) REFERENCES command_patterns(id)
);

CREATE INDEX idx_interactions_layer ON interactions(matched_layer);
CREATE INDEX idx_interactions_user ON interactions(user_id);
CREATE INDEX idx_interactions_created ON interactions(created_at);
CREATE INDEX idx_interactions_fallthrough ON interactions(matched_layer, created_at)
    WHERE matched_layer = 'llm';
```

**Key queries for the evolution job:**

```sql
-- Unprocessed LLM fallthroughs that used HA tools
SELECT * FROM interactions
WHERE matched_layer = 'llm'
AND llm_tool_calls LIKE '%home_assistant%'
AND id NOT IN (SELECT interaction_id FROM learned_patterns)
ORDER BY created_at;

-- Daily stats
SELECT matched_layer, COUNT(*) as count,
       AVG(response_time_ms) as avg_ms
FROM interactions
WHERE created_at > datetime('now', '-1 day')
GROUP BY matched_layer;

-- HA command interception rate
SELECT
    ROUND(100.0 * SUM(CASE WHEN matched_layer = 'tool' THEN 1 ELSE 0 END) /
    COUNT(*), 1) as intercept_pct
FROM interactions
WHERE entities_used != '[]';
```

### speaker_profiles

Voice embeddings for speaker identification.

```sql
CREATE TABLE speaker_profiles (
    id TEXT PRIMARY KEY,                -- UUID
    user_id TEXT,                       -- maps to Open WebUI user (null until linked)
    display_name TEXT NOT NULL,
    embedding BLOB NOT NULL,            -- 256-dim float32 vector (1024 bytes)
    enrolled_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    sample_count INTEGER DEFAULT 1,     -- more samples = better accuracy
    last_verified TIMESTAMP,
    confidence_threshold REAL DEFAULT 0.85  -- per-speaker tunable threshold
);

CREATE INDEX idx_speakers_user ON speaker_profiles(user_id);
```

**Notes:**
- `embedding` is a 256-dimensional float32 vector from resemblyzer
- Cosine similarity > `confidence_threshold` = positive match
- `sample_count` increases with each re-enrollment, improving the average embedding
- Multiple profiles per user possible (e.g., when sick, voice changes)

### emotional_profiles

Per-user personality state that evolves over time.

```sql
CREATE TABLE emotional_profiles (
    user_id TEXT PRIMARY KEY,
    display_name TEXT,
    rapport_score REAL DEFAULT 0.5,     -- 0.0 to 1.0, grows with positive interactions
    preferred_tone TEXT DEFAULT 'neutral', -- casual, formal, playful, technical, warm
    communication_style TEXT,           -- "concise, technical, uses humor"
    humor_style TEXT,                   -- "dry sarcasm", "puns", "wordplay", "none detected"
    filler_pool TEXT DEFAULT '{}',      -- JSON: {"greeting": [...], "question": [...], ...}
    relationship_notes TEXT,            -- LLM-generated personality summary
    peak_hours TEXT DEFAULT '{}',       -- JSON: {"most_active": "21:00-23:00", "morning": false}
    common_topics TEXT DEFAULT '[]',    -- JSON: ["docker", "networking", "home automation"]
    interaction_count INTEGER DEFAULT 0,
    positive_count INTEGER DEFAULT 0,
    negative_count INTEGER DEFAULT 0,
    last_interaction TIMESTAMP,
    last_evolved_at TIMESTAMP,          -- when nightly job last updated this profile
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Rapport score formula:**
```
After each interaction:
  positive sentiment (VADER > 0.2):  rapport += 0.01
  negative sentiment (VADER < -0.2): rapport -= 0.02
  neutral:                           rapport += 0.001 (presence builds rapport)

Clamped to [0.0, 1.0]
Decays by 0.005/day of no interaction (absence lowers rapport slightly)
```

**Tone mapping:**
| Rapport Range | Default Tone |
|---------------|-------------|
| 0.0 - 0.3 | formal, careful |
| 0.3 - 0.6 | neutral, helpful |
| 0.6 - 0.8 | casual, friendly |
| 0.8 - 1.0 | casual-playful, uses humor |

### learned_patterns

Tracks which fallthrough interactions have been processed into patterns.

```sql
CREATE TABLE learned_patterns (
    interaction_id INTEGER PRIMARY KEY,
    pattern_id INTEGER NOT NULL,
    processed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (interaction_id) REFERENCES interactions(id),
    FOREIGN KEY (pattern_id) REFERENCES command_patterns(id)
);
```

### evolution_log

Audit trail for nightly evolution job runs.

```sql
CREATE TABLE evolution_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    run_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    devices_discovered INTEGER DEFAULT 0,
    devices_removed INTEGER DEFAULT 0,
    patterns_generated INTEGER DEFAULT 0,
    patterns_learned INTEGER DEFAULT 0,
    patterns_pruned INTEGER DEFAULT 0,
    profiles_evolved INTEGER DEFAULT 0,
    intercept_rate REAL,                -- % of HA commands handled without LLM
    total_interactions_today INTEGER,
    notes TEXT                          -- LLM-generated summary of the run
);
```

## Entity-Relationship Diagram

```
speaker_profiles ──── user_id ────▶ emotional_profiles
                                          │
                                          │ user_id
                                          ▼
                                    interactions
                                          │
                              pattern_id  │  entities_used
                                  │       │       │
                                  ▼       │       ▼
                          command_patterns │  ha_devices
                                  ▲       │
                                  │       │
                          learned_patterns◀┘

evolution_log (standalone audit trail)
```
